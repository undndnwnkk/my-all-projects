# Лабораторная работа №1 (executor)

## Содержание

1. [Содержание](#содержание)
1. [Задание](#задание)
    1. [Советы](#советы)
1. [Требования к корректности решения](#требования-к-корректности-решения)
    1. [Базовые требования](#базовые-требования)
    1. [Дополнительные требования](#дополнительные-требования)
    1. [Цитатник](#цитатник)
    1. [Бродилка](#бродилка)
    1. [Карта](#карта)
    1. [Стенки](#стенки)
    1. [Аккуратное чтение](#аккуратное-чтение)
1. [Инструкция по сдаче](#инструкция-по-сдаче)
1. [Система оценки](#система-оценки)
1. [Сроки сдачи](#сроки-сдачи)

## Задание
Это задание состоит из пяти частей, вы можете выполнить только префикс и [получить частичные баллы](#система-оценки).
Каждая следующая часть расширяет предыдущие.
Вы пишете интерпретатор команд для некоторого исполнителя.
Решением является один файл `executor.cpp`.

**Внимание!** В этой и всех остальных лабораторных работах весь код надо писать с нуля самостоятельно,
условием делиться нельзя, но можно обсуждать теорию и общие факты про C++ с кем угодно, подробности есть [по ссылке](../common/#честность).

1. **Цитатник**.
   По командам `sherlock-holmes` и `cat-jeoffry` выведите на экран отрывок
   из Шерлока Холмса и Jubilate Agno, соответственно.
   В точности сохраните все пробельные символы, включая переводы строк.
   По команде `quit` успешно завершите интерпретатор.
   У команд могут быть псевдонимы.
   Гарантируется, что входные данные корректны.
2. **Бродилка**.
   Проэмулируйте бродилку по бесконечной квадратной сетке: исходно вы находитесь в клетке `(0, 0)` и смотрите наверх.
   Команды позволяют ходить вперёд, назад, поворачиваться на 90 градусов налево и направо, выводить информацию про текущее положение.
   Также должна поддерживаться запись произвольной последовательности команд, чтобы её потом можно было просто выполнить.
3. **Карта**.
   Добавьте команду рисования исследованной карты при помощи [ASCII графики](https://ru.wikipedia.org/wiki/ASCII-%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D0%BA%D0%B0).
4. **Стенки**.
   Добавьте две новые команды: добавление и удаление стенки перед игроком.
   Если игрок пытается пройти сквозь стену, выводится сообщение `Bump!`.
5. **Аккуратное чтение**.
   Входные данные теперь — произвольная последовательность байт.
   Каждая команда должна располагаться на отдельной строчке, могут быть дописаны пробельные символы в начале или в конце.
   Некорректные команды должны приводить к сообщению `Invalid command: '<команда>'`.

Точный формат смотрите в тестах, а семантику команд — в требованиях ниже.

### Советы
* Прорешайте задачи с прошедших практик.
  Особенно относящиеся к технике: запуск автотестов, использование `clang-format`, address sanitizer...
  Популярные проблемы вроде `: invalid option namee 2: set: pipefail` и их решения также перечислены в условиях практик.
* Добавляйте `#include` _не_ внутри `#ifdef _MSC_VER`/`#endif` — это код только для Visual Studio.
* Выполняйте части сверху вниз.
  Удалите из `tests.txt` тесты, которые вы пока что не собираетесь проходить.
* Никогда не используйте `while (cin)` или `while (cin.eof())` для проверки конца файла.
  Сначала попробуйте прочитать, а потом проверяйте успешность последнего чтения,
  [как тут](https://notes.algoprog.ru/cpp/syntax.html#id12).
* Слово "макрос" в этом задании не имеет никакого отношения к макросам из Си или C++.
* Используйте `std::getline` для построчного чтения.
* Помните, что `char` может быть знаковым типом, `std::isspace` и похожие функции работают с `unsigned char`, а `EOF` на некоторых системах равен `-1`.
* Для крупных типов (вроде `std::string`) используйте передачу по константной ссылке, где разумно.
* Вместо десятка разрозненных констант используйте `enum class` ([scoped enumeration](https://en.cppreference.com/w/cpp/language/enum)).
* Добавьте свои собственные тесты в `tests.txt` и запускайте их на сервере.
* Отдельные функции удобно тестировать в начале `int main()` при помощи `assert`.
    * Удобно выделить функцию `parse_line`, которая превращает строку со входа во что-то более
      простое для обработки: `enum` или `std::optional<>`.
* Заведите константные массивы, в которых будет храниться ожидаемый сдвиг для каждого из четырёх направлений, например:
  ```c++
  struct Direction {
      int dx, dy;
  };
  const Direction DIRECTIONS[] = {{1, 0}, {0, 1}, {-1, 0}, {0, -1}};
  int x = 10, y = 10, direction = 2;
  x += DIRECTIONS[direction].dx;
  y += DIRECTIONS[direction].dy;
  ```
* Не пытайтесь завести двумерный массив для всего поля.
  Придумайте тест, на котором после `n` операций потребуется хранить массив размера `O(n^2)`.
* Вам наверняка пригодятся `std::set`, `std::map` и `std::pair`.
* `clang-tidy` может ругаться на глобальные переменные.
  В общем случае их плохо использовать, но в этом задании разумно, так что можно заглушить соответствующие предупреждения.
* Также `clang-tidy` может предупреждать о рекурсии, которой на самом деле нет, так тоже бывает.
  Если вам нужен именно такой код, то тоже можете заглушить предупреждение.
* Visual Studio может выдавать предупреждение C4459: у вас hiding/shadowing — есть две переменных с одинаковым названием во вложенных scope, считается, что их легко перепутать. Переименуйте. Лучше обе.
  Например, если у вас есть глобальная переменная `x` и локальная `x`, то может иметь смысл конкретизировать, что это за `x`,
  а название `x` оставить для переменных в очень вложенных scope'ах (вроде счётчиков циклов).
  Скажем, можно дать имена вроде `last_visited_x` или `wall_x`.
* Если вы скачаете себе ZIP-архив с репозиторием на Windows, то в файлах с ожидаемыми ответами будут использоваться линуксовые переводы строк — один символ `\n`.
  А под Windows ожидается виндовый перевод строк (два символа: `\r\n`), это автоматически обрабатывается стандартной библиотекой:
  вы выводите `\n`, а она преобразует это в `\r\n`.
  Аналогично с чтением.
  Так как редакторы обычно подстраиваются под стиль переводов строк, ответом и ваш вывод будет выглядеть одинаково,
  но команда `diff` и локальные тесты будут считать, что они отличаются во всех строчках.
  Это чинится преобразованием переводов строк во всех файлах при помощи команды `unix2dos`, которую можно поставить в msys2 командой `pacman -S dos2unix`.

## Требования к корректности решения
### Базовые требования
Действуют [стандартные требования](../common/).

Программа должна занимать не более 400 строк.
Официальное решение занимает 313 строк.

### Дополнительные требования
`n` операций должны работать не медленнее чем `O(n log n + A)` амортизировано, где `A` — размер вывода программы.

### Цитатник
Чтение команд идёт со стандартного потока ввода (`std::cin`), вывод всех результатов — в стандартный поток вывода (`std::cout`).
Каждая команда располагается на отдельной строке.
Символов, кроме команд и переводов строки, нет.
Если команд в потоке ввода больше не осталось (например, если программа на самом деле читает из файла и файл закончился), интерпретатор успешно завершается.

Поддерживаемые команды:

|Псевдонимы|Поведение|
|---|---|
|`quit`, `exit`|Немедленное успешное завершение интерпретатора|
|`sherlock`, `sherlock-holmes`|Вывод на экран цитаты из Шерлока Холмса|
|`cat`, `cat-jeoffry`|Вывод на экран цитаты из Jubilate Agno|

Цитата из Шерлоха Холмса:

```
I had had so many reasons to believe in my friend's subtle powers of
reasoning and extraordinary energy in action that I felt that he must
have some solid grounds for the assured and easy demeanour with which
he treated the singular mystery which he had been called upon to
fathom. Once only had I known him to fail, in the case of the King of
Bohemia and of the Irene Adler photograph; but when I looked back to
the weird business of the Sign of Four, and the extraordinary
circumstances connected with the Study in Scarlet, I felt that it would
be a strange tangle indeed which he could not unravel.
```

Цитата из Jubilate Agno:
```
For he is of the tribe of Tiger.
For the Cherub Cat is a term of the Angel Tiger.
For he has the subtlety and hissing of a serpent, which in goodness he suppresses.
For he will not do destruction, if he is well-fed, neither will he spit without provocation.
For he purrs in thankfulness, when God tells him he's a good Cat.
For he is an instrument for the children to learn benevolence upon.
For every house is incomplete without him and a blessing is lacking in the spirit.
For the Lord commanded Moses concerning the cats at the departure of the Children of Israel from Egypt.
For every family had one cat at least in the bag.
For the English Cats are the best in Europe.
```

Первую цитату следует написать в программе при помощи одного или нескольких обычных строковых литералов: `"Hello"`.
Вторую цитату следует написать при помощи сырых (raw) [строковых литералов](https://en.cppreference.com/w/cpp/language/string_literal): `R"(Hello)"`.

### Бродилка
Поддерживаемые команды:

|Псевдонимы|Поведение|
|---|---|
|`forward`, `fwd`|Пройти на одну клетку вперёд|
|`backward`, `bwd`|Пройти на одну клетку назад|
|`turn-right`, `right`|Повернуться на 90 градусов направо, по часовой стрелке|
|`turn-left`, `left`|Повернуться на 90 градусов налево, против часовой стрелки|
|`print-statistics`, `stats`|Выводит статистику о перемещениях|
|`start-macro`|Начинает запись макроса (смотри ниже)|
|`run-macro`|Запускает записанный ранее макрос|

#### Статистика
Выведите ровно одну строчку со следующей информацией.

* Куда сейчас смотрит игрок (наверх/направо/вниз/налево): один символ из `^`/`>`/`v`/`<`.
* Расстояние от игрока до оси OY в ячейках. Исходно ноль, при хождении наверх/вниз (вдоль оси OY) не меняется, за один ход налево/направо изменяется на 1.
* Расстояние от игрока до оси OX в ячейках. Исходно ноль, при хождении налево/направо (вдоль оси OX) не меняется, за один ход наверх/вниз изменяется на 1.
* Количество различных посещённых ячеек. Исходная ячейка сразу считается посещённой.

Формат следующий.

```
Player ^ stands 2 away from OY, 3 away from OX. 10 cell(s) has been visited.
```

#### Макрос
Интерпретатор помнит ровно один макрос — последний записанный.
Исходно макрос пустой.

При записи макроса команды продолжают читаться так же, как и раньше, но вместо выполнения они записываются в макрос
и выводят на экран сообщение `Recorded`.
В макрос можно записать только команды `forward`, `backward`, `turn-right`, `turn-left`, `print-statistics` и их псевдонимы.
Остальные команды во вводе не возникают.

Запись макроса заканчивается командой `end-macro` или концом файла, после чего на экран выводится сообщение
`New macro of X command(s)`, где `X` — количество команд в макросе.

В обычном режиме можно запустить макрос командой `run-macro`.
Она выполняется так же, как если бы команды из макроса ввели вручную.

### Карта
Добавьте ещё одну команду, в том числе в макросы:

|Псевдонимы|Поведение|
|---|---|
|`show-map`|Выводит на экран текущую карту|

Формат вывода следующий.

Найдём минимальный прямоугольник с осями, параллельными осям координат, содержащий все посещённые игроком клетки.
Пусть он имеет размер `W` клеток в ширину и `H` клеток в высоту.

Тогда карта выводится как `2*H+1` строка, содержащая `2*W+1` символ каждая.
Чётные символы в чётных строках (при нумерации с единицы) соответствуют клеткам:

* `.` — клетка ещё не была посещена игроком; иначе
* `^`/`>`/`v`/`<` — игрок сейчас находится в этой клетке и смотрит наверх/направо/вниз/налево; иначе
* `0` — исходная клетка с координатами `(0, 0)`; иначе
* `o` — клетка была посещена игроком, хотя бы одна из координат не ноль.

Остальные символы в этом задании должны быть пробелами или переводами строк, точный формат смотрите в открытых тестах.
В следующем задании там появятся стенки между клетками.

### Стенки
Добавьте ещё две команды, в том числе в макросы:

|Псевдонимы|Поведение|
|---|---|
|`put-wall`|Поставить стенку перед игроком, если она есть — ничего не делать|
|`remove-wall`|Удалить стенку перед игроком, если её нет — ничего не делать|

Стенки ставятся между клетками.
Каждая стенка загораживает проход между двумя соседними клетками.
Если игрок пытается пройти сквозь стену, то у него это не должно получиться и интерпретатор выводит сообщение `Bump!`.

Стены также должны выводиться на карте.
Для вертикальных стен между клетками используйте `|`, для горизонтальных — `-` (дефис).
В углах клетки ставьте `+` тогда и только когда, когда у этого угла есть хотя бы одна смежная стена.

### Аккуратное чтение
Определим формально формат ввода:

1. Ввод разделяется на строчки по стандартным конвенциям POSIX: строчка (line) — это последовательность байт (возможно, пустая), завершённая ровно одним символом перевода строки (`\n`, код 10).
   Также может быть одна непустая строка (incomplete line) в конце ввода: непустая последовательность байт, после которой вместо `\n` идёт конец ввода.
    * Обработка ОС-специфичных переводов строки (`\r\n` под Windows, `\r` под [Mac OS 9](https://en.wikipedia.org/wiki/Mac_OS_9) и раньше) выполняется стандартной библиотекой языка C++, вам не нужно про это думать.
      В частности, во входном файле при тестировании на Windows байты `\r\n` всегда будут встречаться только рядом друг с другом ровно в таком порядке.
      А стандартная библиотека при чтении превратит это в `\r`.
2. В каждой строке может находиться одно из двух:
    * Команда, возможно, с добавлением пробельных символов (whitespace characters) до или после неё.
      В таких строках интерпретатор выполняет соответствующую команду.
      Пробельные символы берутся только из таблицы ASCII.
    * Любая другая последовательность байт.
      В таких строках интерпретатор выдаёт сообщение `Invalid command: '<последовательность-байт>'`.

В частности, строки могут быть пустыми или состоять только из пробельных символов.
Они вызывают такое же сообщение об ошибке, как и остальные, начинающееся с `Invalid command`.

Если внутри макроса пытаются записать команду, которая макросами не поддерживается,
возникает такое же сообщение `Invalid command`, даже если команда была бы корректна вне макроса.
Такое же поведение если команда `end-macro` встречается вне записи макроса.

## Инструкция по сдаче
[Схема стандартная](../common/#формат-сдачи): вы должны выполнить
задание в отдельной ветке своего существующего закрытого репозитория в организации и в нём же создать Pull Request.
Никаких форков!
В этом задании должно хватить веб-интерфейса GitHub, если возникают проблемы — попросите практика помочь.

Если вы хотите сдать только некоторые части задания, удалите остальные тесты из `tests.txt`.

## Система оценки
[Схема стандартная](../common/#система-оценки), баллы:

|Выполненные части|Макс. корректность|Макс. стиль|Макс. итог|
|---|---|---|---|
|1  |0.5|0.5| 1|
|1-2|1.5|1.5| 3|
|1-3|3  |2  | 5|
|1-4|4  |3  | 7|
|1-5|6  |4  |10|

## Сроки сдачи
Задание выдано 21 сентября 2024 (суббота).
Ниже в каждом случае указано московское время.

* **Дедлайн сдачи:** 29 сентября 2024 (воскресенье), **22**:59.
* Ожидаемый срок проверки: 6 октября 2024 (воскресенье).
* Если первая попытка сдачи достаточно разумна (на усмотрение принимающего),
  то вы можете сделать ещё попытку исправлений или даже несколько.
    * Предложение актуально даже если вы получили автоматический ноль за первую попытку.
    * Выставляется максимум из всех попыток.
* **Срок исправлений**: 13 октября 2024 (воскресенье), **22**:59.
